# Makefile para otimizaÃ§Ã£o do contrato Soroban

.PHONY: build test optimize clean install-deps check-size

# Build normal
build:
	@echo "ğŸ”¨ Building contract..."
	cargo build --target wasm32-unknown-unknown --release

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	cargo test

# Build otimizado
optimize: build
	@echo "ğŸš€ Optimizing WASM..."
	@./optimize.sh

# Verificar tamanho dos arquivos
check-size:
	@echo "ğŸ“Š WASM file sizes:"
	@ls -lh target/wasm32-unknown-unknown/release/*.wasm 2>/dev/null || echo "No WASM files found. Run 'make build' first."

# Instalar dependÃªncias para otimizaÃ§Ã£o
install-deps:
	@echo "ğŸ“¦ Installing optimization dependencies..."
	@command -v wasm-opt >/dev/null 2>&1 || { echo "Installing binaryen (wasm-opt)..."; brew install binaryen; }
	@rustup target add wasm32-unknown-unknown

# Limpar arquivos de build
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cargo clean

# Build completo com otimizaÃ§Ã£o
release: clean test optimize check-size
	@echo "âœ… Release build complete!"

# Deploy para Soroban (exemplo)
deploy: optimize
	@echo "ğŸš€ Deploying optimized contract..."
	@echo "Use: soroban contract deploy --wasm target/wasm32-unknown-unknown/release/payment_with_fee_optimized.wasm --source account --network testnet"

# Verificar se as dependÃªncias estÃ£o instaladas
deps-check:
	@command -v wasm-opt >/dev/null 2>&1 || { echo "âŒ wasm-opt not found. Run 'make install-deps'"; exit 1; }
	@rustup target list --installed | grep -q wasm32-unknown-unknown || { echo "âŒ wasm32-unknown-unknown target not found. Run 'make install-deps'"; exit 1; }
	@echo "âœ… All dependencies are installed"